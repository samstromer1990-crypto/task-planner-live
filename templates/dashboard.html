<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Plan Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --bg: #fafafa; --card: #ffffff; --border: #e6e6e6; --text: #333; --muted: #666; --primary: #0d6efd; }
    body { background: var(--bg); font-family: "Inter", "Segoe UI", Arial, sans-serif; color: var(--text); }
    .nav-container { background: #fff; border-bottom: 1px solid var(--border); padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .nav-title { font-size: 18px; font-weight: 600; }
    .user-info { display: flex; align-items: center; gap: 10px; color: var(--muted); font-size: 14px; }
    .user-info img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .dashboard-layout { display: flex; max-width: 1200px; margin: 0 auto; padding: 28px 12px 60px; }
    .sidebar { width: 280px; flex-shrink: 0; margin-right: 28px; }
    .main-content { flex-grow: 1; min-width: 0; }
    @media (max-width: 992px) { .sidebar { display: none; } .dashboard-layout { display: block; } }
    .task-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; margin-bottom: 10px; transition: border-color .2s ease, box-shadow .2s ease; }
    .task-card:hover { border-color: #d5d5d5; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .task-title { font-weight: 600; }
    .task-muted { color: var(--muted); font-size: 13px; }
    .completed { opacity: .55; text-decoration: line-through; }
    .btn-primary-custom { background: var(--primary); border: 1px solid var(--primary); color: #fff; }
    .btn-primary-custom:hover { background: #0048c6; border-color: #0048c6; }
    .dtl { max-width: 210px; }
    .card { border: 1px solid var(--border); border-radius: 8px; background: #fff; }
    .calendar-widget { padding: 16px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; }
    .calendar-header { font-weight: 600; font-size: 16px; margin-bottom: 10px; color: var(--text); text-align: center; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; }
    .calendar-day-header { color: var(--muted); padding-bottom: 4px; font-weight: 600; }
    .calendar-day { padding: 4px 0; cursor: pointer; border-radius: 4px; transition: background-color 0.2s; }
    .calendar-day:hover { background-color: var(--bg); }
    .calendar-day.today { background-color: var(--primary); color: #fff; font-weight: 700; box-shadow: 0 2px 5px rgba(13, 108, 253, 0.4); }
    canvas { max-height: 250px; }
  </style>
</head>
<body>

  <!-- NAV -->
  <div class="nav-container">
    <div class="nav-title">Plan Hub</div>
    <div class="user-info">
      <span>{{ user.name }}</span>
      {% if user.picture %}
      <img src="{{ user.picture }}" alt="profile">
      {% endif %}
      <a class="btn btn-outline-secondary btn-sm" href="/logout">Logout</a>
    </div>
  </div>

  <!-- MAIN DASHBOARD LAYOUT -->
  <div class="dashboard-layout">
    
    <!-- SIDEBAR -->
    <div class="sidebar">
        
        <!-- Calendar Widget -->
        
        <div class="calendar-widget">
           <div id="calendar-header" class="calendar-header"></div>
           <div class="calendar-grid" id="calendar-grid">
                <div class="calendar-day-header">Mo</div>
                <div class="calendar-day-header">Tu</div>
                <div class="calendar-day-header">We</div>
                <div class="calendar-day-header">Th</div>
                <div class="calendar-day-header">Fr</div>
                <div class="calendar-day-header">Sa</div>
                <div class="calendar-day-header" style="color: #dc3545;">Su</div>
           </div>
        </div>

        <script>
        function buildCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            const monthNames = [
                  "January","February","March","April","May","June",
                  "July","August","September","October","November","December"
            ];
                
            document.getElementById("calendar-header").textContent =
                `${monthNames[month]} ${year}`;
                
            const grid = document.getElementById("calendar-grid");
            
            // Remove old days (keep headers)
            grid.querySelectorAll(".calendar-day").forEach(el => el.remove());
              
            const firstDay = new Date(year, month, 1);
            let start = firstDay.getDay();  // 0=Sun, 1=Mon, ...
            if (start === 0) start = 7;     // Move Sunday to end (ISO format)
             
            const daysInMonth = new Date(year, month + 1, 0).getDate();
             
            // Empty cells before day 1
            for (let i = 1; i < start; i++) {
                 let empty = document.createElement("div");
                 empty.className = "calendar-day";
                 empty.style.visibility = "hidden";
                 grid.appendChild(empty);
            }
              
             // Fill actual days
             for (let d = 1; d <= daysInMonth; d++) {
                  const div = document.createElement("div");
                  div.className = "calendar-day";
                  div.textContent = d;
                   
                  if (
                     d === now.getDate() &&
                     month === now.getMonth() &&
                     year === now.getFullYear()
                  ) {
                     div.classList.add("today");
                  }
                
                  // Sundays red
                  const cellIndex = (start - 1) + (d - 1);
                  if ((cellIndex % 7) === 6) {
                       div.style.color = "#dc3545";
                  }
                   
                  grid.appendChild(div);
             }
        }
        
        buildCalendar();
        </script>
        
        
        <!-- PIE CHART for Completion % -->
        <div class="card p-3">
            <h6 class="mb-3">üìä Task Completion</h6>
            <canvas id="completionPieChart" width="250" height="250"></canvas>
            <div class="mt-3 text-center">
                <div class="text-muted small">Total Tasks: <span class="fw-bold" id="totalTasks">-</span></div>
                <div class="text-muted small">Pending: <span class="text-danger fw-bold" id="pendingTasks">-</span></div>
                <div class="text-muted small">Completed: <span class="text-success fw-bold" id="completedTasks">-</span></div>
            </div>
        </div>

    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <h2>Hey {{ user.name.split(' ')[0] if user.name else 'there' }} üëã</h2>
      <div class="text-muted mb-3">Add tasks, set reminders, mark complete. Emails fire automatically.</div>

      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Your Tasks</h4>
        <button class="btn btn-primary-custom btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">Add Task</button>
      </div>

      <!-- TASK LIST -->
      {% for task in tasks %}
      <div class="task-card {% if task.completed %}completed{% endif %}">
        <div class="row g-2 align-items-center">
          <div class="col-md-6">
            <div class="task-title">{{ task.task }}</div>
            <div class="task-muted">
              {% if task.completed %}‚úî Completed{% else %}‚è≥ Pending{% endif %}
              {% if task.category %} ‚Ä¢ {{ task.category }}{% endif %}
            </div>

            <!-- FIXED: IST Timezone Display -->
            <div class="task-muted small mt-1 ist-time">
              Due: <span data-utc="{{ task.raw_reminder_time }}">{{ task.raw_reminder_time | replace('Z', '') | truncate(16, True, '') }}</span>
            </div>

            <form action="/update-time/{{ task.id }}" method="POST" class="d-flex align-items-center gap-2 mt-2">
              <input type="datetime-local" name="reminder_time" 
                     value="{{ task.raw_reminder_time | replace('Z', '') | truncate(16, True, '') }}" 
                     class="form-control form-control-sm dtl">
              <button class="btn btn-outline-secondary btn-sm">Save</button>
            </form>
          </div>

          <!-- Action Buttons -->
          <div class="col-md-6 text-md-end d-flex justify-content-end align-items-center gap-2">
            <a href="/delete/{{ task.id }}" 
               class="btn btn-outline-danger btn-sm" 
               onclick="return confirm('Delete task: {{ task.task | e }}?');">
               Delete
            </a>
            {% if not task.completed %}
            <a href="/complete/{{ task.id }}" class="btn btn-primary-custom btn-sm">Mark Complete</a>
            {% else %}
            <span class="badge bg-success">Done</span>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}

      {% if tasks|length == 0 %}
      <div class="alert alert-light border text-center mt-3">No tasks yet. Click "Add Task" to create one.</div>
      {% endif %}

      <!-- ADD TASK MODAL -->
      <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Task</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/add-task" method="POST">
              <div class="modal-body">
                <label class="form-label">Task Name</label>
                <input type="text" name="task_name" class="form-control mb-3" required>
                
                <label class="form-label">Category</label>
                <select name="category" class="form-control mb-3">
                  <option value="Personal" selected>Personal</option>
                  <option value="Work">Work</option>
                  <option value="Study">Study</option>
                  <option value="Uncategorized">Uncategorized</option>
                </select>

                <label class="form-label">Reminder Time</label>
                <input type="datetime-local" name="reminder_time" class="form-control">
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary-custom">Add Task</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- AI SECTION -->
      <div class="card p-3 mt-4">
        <h5>AI Assistant ü§ñ</h5>
        <p class="text-muted">Ask anything. AI will help extract tasks or chat.</p>
        <div class="input-group mb-2">
          <input id="ai_input" class="form-control" placeholder="e.g., Remind me to study physics tomorrow at 4 PM">
          <button class="btn btn-primary-custom" onclick="sendToAI()">Ask</button>
        </div>
        <pre id="ai_output" class="p-2 bg-light" style="min-height:100px; white-space: pre-wrap;"></pre>
      </div>

    </div> <!-- End Main Content -->
  </div> <!-- End Dashboard Layout -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- AI Script -->
  <script>
async function sendToAI() {
    const text = document.getElementById("ai_input").value;
    const aiOutput = document.getElementById("ai_output");
    aiOutput.innerText = "Processing...";

    try {
        const res = await fetch("/ai-process", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_input: text })
        });

        const data = await res.json();

        if (data.type === "error") {
            aiOutput.innerText = "‚ùå Error:\n" + (data.message || JSON.stringify(data, null, 2));
            return;
        }

        if (data.action !== "add") {
            const chatResponse = data.response || JSON.stringify(data, null, 2);
            aiOutput.innerText = "ü§ñ Assistant:\n" + chatResponse;
            return;
        }

        const timeDisplay = data.reminder_time 
            ? data.reminder_time.replace('Z', '').substring(0, 16) 
            : 'None';
            
        aiOutput.innerText =
            "‚úÖ Task added:\n" +
            "Task: " + data.task + "\n" +
            "Category: " + (data.category || 'Uncategorized') + "\n" +
            "Time (UTC): " + timeDisplay;

        setTimeout(() => { window.location.reload(); }, 800);
        
    } catch (e) {
        aiOutput.innerText = "‚ùå Network or unexpected error: " + e.message;
    }
}
</script>

  <!-- IST TIMEZONE & PIE CHART Script -->
  <script>
// Convert UTC times to IST (UTC+5:30) for display
function convertToIST(utcString) {
    if (!utcString) return 'No reminder';
    
    try {
        // Parse UTC datetime
        const utcDate = new Date(utcString);
        
        // Add 5 hours 30 minutes for IST
        const istOffset = 5.5 * 60 * 60 * 1000; // 5.5 hours in milliseconds
        const istDate = new Date(utcDate.getTime() + istOffset);
        
        // Format as DD-MM-YYYY HH:MM
        const day = String(istDate.getDate()).padStart(2, '0');
        const month = String(istDate.getMonth() + 1).padStart(2, '0');
        const year = istDate.getFullYear();
        const hours = String(istDate.getHours()).padStart(2, '0');
        const minutes = String(istDate.getMinutes()).padStart(2, '0');
        
        return `${day}-${month}-${year} ${hours}:${minutes} IST`;
    } catch (e) {
        return utcString; // Fallback if parsing fails
    }
}

// Apply IST conversion to all task times when page loads
document.addEventListener('DOMContentLoaded', function() {
    const timeElements = document.querySelectorAll('.ist-time span');
    timeElements.forEach(el => {
        const utcTime = el.getAttribute('data-utc');
        if (utcTime) {
            el.textContent = `Due: ${convertToIST(utcTime)}`;
        }
    });
});

// Load pie chart showing completion percentage
async function loadCharts() {
    try {
        const res = await fetch('/stats.json');
        const data = await res.json();
        
        if (data.error) {
            console.error("Stats error:", data.error);
            return;
        }

        // Calculate totals
        const totalTasks = data.total_tasks || 0;
        const completedTasks = data.completed_by_category?.reduce((a, b) => a + b, 0) || 0;
        const pendingTasks = totalTasks - completedTasks;

        // Update summary
        document.getElementById('totalTasks').textContent = totalTasks;
        document.getElementById('completedTasks').textContent = completedTasks;
        document.getElementById('pendingTasks').textContent = pendingTasks;

        // Destroy existing chart if it exists
        if (window.completionPieChartInstance) window.completionPieChartInstance.destroy();

        // Pie Chart for Completion Percentage
        const pieCtx = document.getElementById('completionPieChart').getContext('2d');
        window.completionPieChartInstance = new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: ['Completed', 'Pending'],
                datasets: [{
                    data: [completedTasks, pendingTasks],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

    } catch (e) {
        console.error("Failed to load charts:", e);
    }
}

// Load charts on page load
document.addEventListener('DOMContentLoaded', loadCharts);
</script>

</body>
</html>



