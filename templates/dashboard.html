<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Task Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --bg: #fafafa;
      --card: #ffffff;
      --border: #e6e6e6;
      --text: #333;
      --muted: #666;
      --primary: #0d6efd;
    }

    body {
      background: var(--bg);
      font-family: "Inter", "Segoe UI", Arial, sans-serif;
      color: var(--text);
    }

    /* Navigation */
    .nav-container {
      background: #fff;
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-title { font-size: 18px; font-weight: 600; }
    .user-info { display: flex; align-items: center; gap: 10px; color: var(--muted); font-size: 14px; }
    .user-info img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }

    /* Dashboard Layout (New) */
    .dashboard-layout {
      display: flex;
      max-width: 1200px; /* Wider max width for the whole app */
      margin: 0 auto;
      padding: 28px 12px 60px;
    }
    .sidebar {
      width: 280px;
      flex-shrink: 0;
      margin-right: 28px;
    }
    .main-content {
      flex-grow: 1;
      min-width: 0; /* Important for flex to shrink content correctly */
    }

    /* Mobile Responsiveness for Sidebar */
    @media (max-width: 992px) {
      .sidebar {
        display: none; /* Hide sidebar on small screens */
      }
      .dashboard-layout {
        padding: 28px 12px 60px;
        display: block; /* Switch to single column */
      }
    }

    /* Card and List Styles */
    .task-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 10px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .task-card:hover { border-color: #d5d5d5; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .task-title { font-weight: 600; }
    .task-muted { color: var(--muted); font-size: 13px; }
    .completed { opacity: .55; text-decoration: line-through; }
    .btn-primary-custom {
      background: var(--primary);
      border: 1px solid var(--primary);
      color: #fff;
    }
    .btn-primary-custom:hover { background: #0048c6; border-color: #0048c6; }
    .dtl { max-width: 210px; }
    .card { border: 1px solid var(--border); border-radius: 8px; background: #fff; }

    /* Calendar Widget Styles */
    .calendar-widget {
        padding: 16px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .calendar-header {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 10px;
        color: var(--text);
        text-align: center;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-size: 12px;
    }
    .calendar-day-header {
        color: var(--muted);
        padding-bottom: 4px;
        font-weight: 600;
    }
    .calendar-day {
        padding: 4px 0;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    .calendar-day:hover {
        background-color: var(--bg);
    }
    .calendar-day.today {
        background-color: var(--primary);
        color: #fff;
        font-weight: 700;
        box-shadow: 0 2px 5px rgba(13, 108, 253, 0.4);
    }
  </style>
</head>
<body>

  <!-- NAV -->
  <div class="nav-container">
    <div class="nav-title">Your Task Planner</div>
    <div class="user-info">
      <span>{{ user.name }}</span>
      {% if user.picture %}
      <img src="{{ user.picture }}" alt="profile">
      {% endif %}
      <a class="btn btn-outline-secondary btn-sm" href="/logout">Logout</a>
    </div>
  </div>

  <!-- MAIN DASHBOARD LAYOUT -->
  <div class="dashboard-layout">
    
    <!-- SIDEBAR (Calendar & Stats) -->
    <div class="sidebar">
        
        <!-- Calendar Widget (Static Placeholder) -->
        <div class="calendar-widget">
            <div class="calendar-header">November 2025</div>
            <div class="calendar-grid">
                <div class="calendar-day-header">Mo</div>
                <div class="calendar-day-header">Tu</div>
                <div class="calendar-day-header">We</div>
                <div class="calendar-day-header">Th</div>
                <div class="calendar-day-header">Fr</div>
                <div class="calendar-day-header">Sa</div>
                <div class="calendar-day-header" style="color: #dc3545;">Su</div>
                <!-- Example days (November 2025 starts on a Saturday) -->
                <div class="calendar-day" style="grid-column: 6;">1</div>
                <div class="calendar-day" style="color: #dc3545;">2</div>
                <div class="calendar-day">3</div>
                <div class="calendar-day">4</div>
                <div class="calendar-day">5</div>
                <div class="calendar-day">6</div>
                <div class="calendar-day">7</div>
                <div class="calendar-day">8</div>
                <div class="calendar-day" style="color: #dc3545;">9</div>
                <div class="calendar-day">10</div>
                <div class="calendar-day">11</div>
                <div class="calendar-day">12</div>
                <div class="calendar-day">13</div>
                <div class="calendar-day">14</div>
                <div class="calendar-day">15</div>
                <div class="calendar-day" style="color: #dc3545;">16</div>
                <div class="calendar-day">17</div>
                <div class="calendar-day">18</div>
                <div class="calendar-day">19</div>
                <div class="calendar-day">20</div>
                <div class="calendar-day">21</div>
                <div class="calendar-day">22</div>
                <div class="calendar-day" style="color: #dc3545;">23</div>
                <div class="calendar-day">24</div>
                <div class="calendar-day">25</div>
                <div class="calendar-day">26</div>
                <div class="calendar-day">27</div>
                <div class="calendar-day">28</div>
                <div class="calendar-day today">29</div> <!-- Set to 29 to represent today's date -->
                <div class="calendar-day" style="color: #dc3545;">30</div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="card p-3">
            <h6 class="mb-2">Task Summary</h6>
            <div class="text-muted small">Total Tasks: <span class="fw-bold">{{ tasks|length }}</span></div>
            <div class="text-muted small">Completed: <span class="text-success fw-bold">{{ tasks | selectattr('completed', 'equalto', true) | list | length }}</span></div>
            <div class="text-muted small">Pending: <span class="text-danger fw-bold">{{ tasks | selectattr('completed', 'equalto', false) | list | length }}</span></div>
        </div>

    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      
      <!-- Display Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <h2>Hey {{ user.name.split(' ')[0] if user.name else 'there' }} üëã</h2>
      <div class="text-muted mb-3">Add tasks, set reminders, mark complete. Emails fire automatically.</div>

      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Your Tasks</h4>
        <button class="btn btn-primary-custom btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">Add Task</button>
      </div>

      <!-- TASK LIST -->
      {% for task in tasks %}
      <div class="task-card {% if task.completed %}completed{% endif %}">
        <div class="row g-2 align-items-center">
          <div class="col-md-6">
            <div class="task-title">{{ task.task }}</div>
            <div class="task-muted">{% if task.completed %}‚úî Completed{% else %}‚è≥ Pending{% endif %}</div>

            <form action="/update-time/{{ task.id }}" method="POST" class="d-flex align-items-center gap-2 mt-2">
              <input type="datetime-local" name="reminder_time" 
                     value="{{ task.raw_reminder_time | replace('Z', '') | truncate(16, True, '') }}" 
                     class="form-control form-control-sm dtl">
              <button class="btn btn-outline-secondary btn-sm">Save</button>
            </form>
          </div>

          <!-- Delete and Complete Buttons -->
          <div class="col-md-6 text-md-end d-flex justify-content-end align-items-center gap-2">
            
            <!-- FIX: Replaced onclick=confirm() with a Bootstrap modal trigger -->
            <a href="#" 
               class="btn btn-outline-danger btn-sm delete-task-btn" 
               data-bs-toggle="modal" 
               data-bs-target="#deleteConfirmModal"
               data-task-id="{{ task.id }}"
               data-task-name="{{ task.task | e }}">
               Delete
            </a>

            {% if not task.completed %}
            <a href="/complete/{{ task.id }}" class="btn btn-primary-custom btn-sm">Mark Complete</a>
            {% else %}
            <span class="badge bg-success">Done</span>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}

      {% if tasks|length == 0 %}
      <div class="alert alert-light border text-center mt-3">No tasks yet. Click "Add Task" to create one.</div>
      {% endif %}

      <!-- ADD TASK MODAL -->
      <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Task</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form action="/add-task" method="POST">
              <div class="modal-body">
                <label class="form-label">Task Name</label>
                <input type="text" name="task_name" class="form-control mb-3" required>

                <label class="form-label">Reminder Time</label>
                <input type="datetime-local" name="reminder_time" class="form-control">
              </div>

              <div class="modal-footer">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary-custom">Add Task</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- NEW: DELETE CONFIRMATION MODAL -->
      <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete the task: <span id="taskToDeleteName" class="fw-bold text-danger"></span>?
              This action cannot be undone.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <a id="confirmDeleteButton" href="#" class="btn btn-danger">Yes, Delete Task</a>
            </div>
          </div>
        </div>
      </div>

      <!-- AI SECTION -->
      <div class="card p-3 mt-4">
        <h5>AI Assistant ü§ñ</h5>
        <p class="text-muted">Ask anything. AI will help extract tasks or chat.</p>

        <div class="input-group mb-2">
          <input id="ai_input" class="form-control" placeholder="e.g., Remind me to study physics tomorrow at 4 PM">
          <button class="btn btn-primary-custom" onclick="sendToAI()">Ask</button>
        </div>

        <pre id="ai_output" class="p-2 bg-light" style="min-height:100px; white-space: pre-wrap;"></pre>
      </div>

    </div> <!-- End Main Content -->

  </div> <!-- End Dashboard Layout -->

    
  <script>
async function sendToAI() {
    const text = document.getElementById("ai_input").value;
    const aiOutput = document.getElementById("ai_output");
    aiOutput.innerText = "Processing...";

    try {
        const res = await fetch("/ai-process", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_input: text })
        });

        const data = await res.json();

        // If AI returns an error ‚Üí show it
        if (data.type === "error") {
            aiOutput.innerText = "‚ùå Error:\n" + (data.message || JSON.stringify(data, null, 2));
            return;
        }

        // If AI returns a general conversation ‚Üí show it
        if (data.action !== "add") {
             // For general chat, display the response cleanly
            const chatResponse = data.response || JSON.stringify(data, null, 2);
            aiOutput.innerText = "ü§ñ Assistant:\n" + chatResponse;
            return;
        }

        // If AI successfully added a task
        // Clean up the ISO string for display (remove Z and milliseconds)
        const timeDisplay = data.reminder_time 
            ? data.reminder_time.replace('Z', '').substring(0, 16) 
            : 'None';
            
        aiOutput.innerText =
            "‚úÖ Task added:\n" +
            "Task: " + data.task + "\n" +
            "Time (UTC): " + timeDisplay;

        // Refresh automatically to show the new task
        setTimeout(() => {
            window.location.reload();
        }, 800);
        
    } catch (e) {
        aiOutput.innerText = "‚ùå Network or unexpected error: " + e.message;
    }
}

// NEW JS: Handles dynamically setting the delete URL when the confirmation modal is opened.
document.addEventListener('DOMContentLoaded', () => {
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    if (deleteConfirmModal) {
        deleteConfirmModal.addEventListener('show.bs.modal', function (event) {
            // Button that triggered the modal (the 'Delete' link)
            const button = event.relatedTarget;
            
            // Extract info from data-* attributes on the 'Delete' link
            const taskId = button.getAttribute('data-task-id');
            const taskName = button.getAttribute('data-task-name');

            // Find elements inside the modal
            const modalBodyName = deleteConfirmModal.querySelector('#taskToDeleteName');
            const confirmButton = deleteConfirmModal.querySelector('#confirmDeleteButton');

            // Update the modal's content and the final deletion link
            modalBodyName.textContent = taskName;
            confirmButton.href = `/delete/${taskId}`;
        });
    }
});

</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
