<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Task Planner Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

<style>
/* --- DESIGN SYSTEM BASED ON DESIRED IMAGE --- */
:root{
Â  --bg: #f4f1fb; /* Light purple-gray background */
Â  --panel: #fff; /* White cards */
Â  --metric-card: #fff;
Â  --muted: #7b7f88;
Â  --primary: #7c5cff; /* Main purple/accent */
Â  --accent: #bfa8ff;
Â  --radius: 14px;
Â  --shadow: 0 12px 30px rgba(22,18,32,0.06);
Â  --task-shadow: 0 2px 8px rgba(0,0,0,0.02);
}

/* Base */
*{box-sizing:border-box}
body{
Â  margin:0;
Â  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
Â  background:var(--bg);
Â  color:#111827;
}

/* Dark Mode (Basic structure for future implementation) */
body.dark-mode {
    --bg: #1e1e2d;
    --panel: #27293d;
    --metric-card: #27293d;
    --muted: #a0a0b0;
    --text: #f0f0f5;
    color: var(--text);
}
body.dark-mode .task-row { border-color: #3b3d50; }
body.dark-mode .chart-placeholder { background: #33354a; }
body.dark-mode .calendar-widget { background: var(--panel); }
body.dark-mode .progress-bar-custom { background-color: #3b3d50; }


/* App Layout & Grid */
.app-container {Â 
Â  max-width: 1200px;
Â  margin: 0 auto;
Â  padding: 20px;
}
.header-bar {
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;
Â  margin-bottom: 24px;
}
.main-grid {
Â  display: grid;
Â  grid-template-columns: 1fr 300px; /* Content (Task List) | Sidebar (Calendar) */
Â  gap: 24px;
}
@media (max-width: 992px) {
Â  .main-grid { 
        grid-template-columns: 1fr;
        /* Sidebar comes first on mobile for contextual info */
        grid-template-areas: "sidebar" "main-content";
    }
    .sidebar-content { grid-area: sidebar; }
    .main-content-area { grid-area: main-content; }
}

/* General Card Styles */
.card-panel {
Â  background:var(--panel);
Â  border-radius:var(--radius);
Â  padding:20px;
Â  box-shadow: var(--shadow);
Â  margin-bottom: 24px;
}

/* --- HERO/METRICS (Check your daily tasks & schedules) --- */
.hero-container {
Â  background: var(--metric-card);
Â  border-radius: var(--radius);
Â  box-shadow: var(--shadow);
Â  padding: 24px;
Â  margin-bottom: 24px;
Â  display: flex;
Â  gap: 24px;
}
.hero-main { flex: 1; }
.hero-title { font-size: 20px; font-weight: 700; color: inherit; margin: 0 0 4px; }
.hero-subtitle { color: var(--muted); font-size: 14px; margin-bottom: 16px; }

.metrics-row {
Â  display: flex;
Â  gap: 12px;
Â  justify-content: space-between;
Â  flex-wrap: wrap;
}
.metric {
Â  flex: 1;
Â  min-width: 100px;
Â  max-width: 140px;
Â  padding: 10px 0;
}
.metric h4 { margin: 0; font-weight: 700; }
.metric small { color: var(--muted); font-size: 12px; }

/* Progress Bar */
.metric-progress {
Â  flex: 1;
Â  min-width: 180px;
Â  display: flex;
Â  flex-direction: column;
Â  justify-content: center;
}
.progress-bar-custom {
Â  height: 10px;
Â  background-color: #e9e6f3;
Â  border-radius: 5px;
Â  overflow: hidden;
}
.progress-fill {
Â  height: 100%;
Â  background: linear-gradient(90deg, var(--primary), var(--accent));
Â  transition: width 0.5s ease-in-out;
}

/* Task Breakdown Chart Placeholder (Right side of Hero) */
.chart-placeholder {
Â  width: 140px;
Â  background: #fdfdfd;
Â  border-radius: 10px;
Â  padding: 10px;
Â  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
Â  text-align: center;
}
.chart-title { font-size: 12px; font-weight: 600; margin-bottom: 6px; color: inherit; }
.chart-area {Â 
Â  height: 50px;Â 
Â  background: #f0f0f0;Â 
Â  border-radius: 6px;
Â  /* Simple bar representation */
Â  display: flex;
Â  align-items: flex-end;
Â  padding: 4px;
Â  gap: 2px;
}
.bar { width: 10px; background: var(--primary); border-radius: 2px 2px 0 0; }

/* --- TASK LIST STYLES --- */
.task-row {
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;
Â  background: var(--panel);
Â  border-radius: 8px;
Â  padding: 14px 16px;
Â  margin-bottom: 10px;
Â  border: 1px solid #eee;
Â  box-shadow: var(--task-shadow);
}
.task-row:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }

.task-details {
Â  display: flex;
Â  align-items: center;
Â  gap: 15px;
Â  flex-grow: 1;
}
.task-actions {
Â  display: flex;
Â  gap: 8px;
Â  align-items: center;
}
.initials-avatar {
Â  width: 36px;
Â  height: 36px;
Â  border-radius: 8px;
Â  background: #e9e6f3;
Â  color: var(--primary);
Â  font-weight: 700;
Â  display: flex;
Â  align-items: center;
Â  justify-content: center;
Â  font-size: 14px;
Â  flex-shrink: 0;
}
.task-title-main { font-weight: 600; font-size: 15px; margin: 0; }
.task-meta { font-size: 12px; color: var(--muted); }
.task-meta .priority-low { color: green; font-weight: 600; }
.task-meta .priority-med { color: orange; font-weight: 600; }
.task-meta .priority-high { color: red; font-weight: 600; }

/* Completed Task State */
.task-row.completed .task-title-main { text-decoration: line-through; opacity: 0.7; }
.task-row.completed .initials-avatar { background: #d4e8c1; color: #507b27; }

/* --- SIDEBAR CALENDAR STYLES --- */
.sidebar-content {
Â  position: sticky;
Â  top: 20px; /* Offset from the top */
}
.calendar-widget {
Â  padding: 16px;
Â  background: var(--panel);
Â  border-radius: var(--radius);
Â  box-shadow: var(--shadow);
Â  margin-bottom: 24px;
}
.calendar-header {
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;
Â  margin-bottom: 10px;
}
.calendar-month { font-weight: 700; font-size: 16px; }
.calendar-grid {
Â  display: grid;
Â  grid-template-columns: repeat(7, 1fr);
Â  text-align: center;
Â  font-size: 12px;
}
.calendar-day-header {
Â  color: var(--muted);
Â  padding-bottom: 6px;
Â  font-weight: 600;
}
.calendar-day {
Â  padding: 6px 0;
Â  border-radius: 6px;
Â  font-weight: 600;
}
.calendar-day.today {
Â  background-color: var(--primary);
Â  color: #fff;
Â  box-shadow: 0 2px 6px rgba(124,92,255,0.4);
}
.calendar-day.event { border: 1px solid var(--accent); }

/* --- BUTTONS & UTILITIES --- */
.btn-primary-custom {
Â  background: var(--primary);
Â  border: 1px solid var(--primary);
Â  color: #fff;
}
.btn-primary-custom:hover { background: #6a49e6; border-color: #6a49e6; }
.btn-sm-custom { padding: 4px 10px; font-size: 13px; border-radius: 6px; }

/* Adjustments for Bootstrap date input */
.datetime-input { max-width: 170px; font-size: 13px; }

/* Custom styling for flash messages */
.flash-message-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050; /* Above modals */
    width: 300px;
}
</style>
</head>
<body>

<div class="app-container">
Â  <div class="header-bar">
Â  Â  <h2 style="margin:0; font-weight:700">Welcome back <span id="userNameDisplay">{% if user.name %}{{ user.name.split(' ')[0] }}{% else %}there{% endif %} ğŸ‘‹</span></h2>
Â  Â  <div class="d-flex gap-2">
Â  Â  Â  <button id="themeToggle" class="btn btn-outline-secondary btn-sm-custom">Dark</button>
Â  Â  Â  <a class="btn btn-outline-secondary btn-sm-custom" href="{{ url_for('logout') }}">Logout</a>
Â  Â  Â  <button class="btn btn-primary-custom btn-sm-custom" data-bs-toggle="modal" data-bs-target="#addTaskModal">+ Add Task</button>
Â  Â  </div>
Â  </div>

    <!-- Flash Message Container -->
    <div class="flash-message-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show mt-2" role="alert" style="border-radius:10px;">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

Â  Â  <div class="main-grid">

Â  Â  Â  Â  <div class="main-content-area">
Â  Â  Â  Â  Â  Â  <section class="hero-container">
Â  Â  Â  Â  <div class="hero-main">
Â  Â  Â  Â  Â  <p style="color:var(--muted); font-size:14px; margin-bottom: 2px;">Today's Task</p>
Â  Â  Â  Â  Â  <h3 class="hero-title">Check your daily tasks & schedules</h3>
Â  Â  Â  Â  Â  <p class="hero-subtitle">Quick glance at progress and what's due today.</p>

Â  Â  Â  Â  Â  <div class="metrics-row">
Â  Â  Â  Â  Â  Â  <div class="metric">
Â  Â  Â  Â  Â  Â  Â  <small>Total Tasks</small>
Â  Â  Â  Â  Â  Â  Â  <h4 id="totalShow">{{ tasks|length }}</h4>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="metric">
Â  Â  Â  Â  Â  Â  Â  <small>Completed</small>
Â  Â  Â  Â  Â  Â  Â  <h4 id="doneShow" class="text-success">{{ tasks | selectattr('completed', 'equalto', true) | list | length }}</h4>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="metric">
Â  Â  Â  Â  Â  Â  Â  <small>Pending</small>
Â  Â  Â  Â  Â  Â  Â  <h4 id="pendingShow" class="text-danger">{{ tasks | selectattr('completed', 'equalto', false) | list | length }}</h4>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="metric-progress">
Â  Â  Â  Â  Â  Â  Â  <small>Progress</small>
Â  Â  Â  Â  Â  Â  Â  {% set total = tasks|length %}
Â  Â  Â  Â  Â  Â  Â  {% set done = tasks | selectattr('completed', 'equalto', true) | list | length %}
Â  Â  Â  Â  Â  Â  Â  {% set pct = (done / total * 100) | round(0) if total > 0 else 0 %}
Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar-custom mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-fill" style="width:{{ pct }}%"></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <small style="margin-top: 4px; font-weight:600;">{{ pct }}% Overall completion</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-placeholder d-none d-md-block">
Â  Â  Â  Â  Â  <div class="chart-title">This Week</div>
Â  Â  Â  Â  Â  <div style="font-size:10px; color:var(--muted)">Task Breakdown</div>
Â  Â  Â  Â  Â  <div class="chart-area mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bar" style="height: 40%"></div>
Â  Â  Â  Â  Â  Â  <div class="bar" style="height: 60%"></div>
Â  Â  Â  Â  Â  Â  <div class="bar" style="height: 30%"></div>
Â  Â  Â  Â  Â  Â  <div class="bar" style="height: 80%"></div>
Â  Â  Â  Â  Â  Â  <div class="bar" style="height: 50%"></div>
Â  Â  Â  Â  Â  Â  <div class="bar" style="height: 20%"></div>
Â  Â  Â  Â  Â  Â  <div class="bar" style="height: 10%"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="font-size:10px; color:var(--muted); margin-top:4px;">Mon Tue Wed Thu Fri Sat Sun</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  <h4 style="margin-bottom: 12px;">Your Tasks</h4>

Â  Â  Â  Â  {% for task in tasks %}
Â  Â  Â  Â  <div class="task-row {% if task.completed %}completed{% endif %}">
Â  Â  Â  Â  Â  <div class="task-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="initials-avatar">{{ task.task[:2] | upper }}</div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <p class="task-title-main">{{ task.task }}</p>
Â  Â  Â  Â  Â  Â  Â  <div class="task-meta">
Â  Â  Â  Â  Â  Â  Â  Â  Due:Â 
Â  Â  Â  Â  Â  Â  Â  Â  {% if task.raw_reminder_time %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ task.raw_reminder_time | replace('Z', '') | truncate(10, True, '') }}
Â  Â  Â  Â  Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  No Date
Â  Â  Â  Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  Â  Â  Â  Â  â€¢ <span class="priority-med">MED</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="task-actions">
Â  Â  Â  Â  Â  Â  {% if not task.completed %}
Â  Â  Â  Â  Â  Â  <a href="{{ url_for('complete_task', record_id=task.id) }}" class="btn btn-primary-custom btn-sm-custom">Done</a>
Â  Â  Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  Â  Â  <a href="{{ url_for('complete_task', record_id=task.id) }}" class="btn btn-outline-secondary btn-sm-custom">Undo</a>
Â  Â  Â  Â  Â  Â  {% endif %}

Â  Â  Â  Â  Â  Â  <a href="{{ url_for('delete_task', record_id=task.id) }}"
Â  Â  Â  Â  Â  Â  Â class="btn btn-outline-danger btn-sm-custom"
Â  Â  Â  Â  Â  Â  Â onclick="return confirm('Delete task: {{ task.task | e }}?');">
Â  Â  Â  Â  Â  Â  Â  Delete
Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <form action="{{ url_for('update_time', record_id=task.id) }}" method="POST" class="d-flex align-items-center gap-2 mb-3 ms-5">
Â  Â  Â  Â  Â  <input type="datetime-local" name="reminder_time"
Â  Â  Â  Â  Â  Â  Â  Â  Â value="{{ task.raw_reminder_time | replace('Z', '') | truncate(16, True, '') }}"
Â  Â  Â  Â  Â  Â  Â  Â  Â class="form-control datetime-input">
Â  Â  Â  Â  Â  <button class="btn btn-outline-secondary btn-sm-custom">Save Time</button>
Â  Â  Â  Â  </form>
Â  Â  Â  Â  {% endfor %}

Â  Â  Â  Â  {% if tasks|length == 0 %}
Â  Â  Â  Â  <div class="alert alert-light border text-center mt-3" style="border-radius:10px;">No tasks yet. Click "+ Add Task" to create one.</div>
Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-panel mt-4">
Â  Â  Â  Â  Â  <h5>AI Assistant ğŸ¤–</h5>
Â  Â  Â  Â  Â  <p class="text-muted small">Ask anything. AI will help extract tasks or chat.</p>

Â  Â  Â  Â  Â  <div class="input-group mb-2">
Â  Â  Â  Â  Â  Â  <input id="ai_input" class="form-control" placeholder="e.g., Remind me to study physics tomorrow at 4 PM">
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary-custom" onclick="sendToAI()">Ask</button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <pre id="ai_output" class="p-3" style="min-height:100px; white-space: pre-wrap; background:var(--bg); border-radius:10px; border:1px solid #e9e6f3;">Hello! Ask me to schedule a task or any general question.</pre>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>


Â  Â  Â  Â  <div class="sidebar-content">
Â  Â  Â  Â  Â  Â  <div class="calendar-widget">
Â  Â  Â  Â  <div class="calendar-header">
Â  Â  Â  Â  Â  <span class="calendar-month">November 2025</span>
Â  Â  Â  Â  Â  <small style="color:var(--primary); font-weight:600;">Add</small>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="calendar-grid">
Â  Â  Â  Â  Â  <div class="calendar-day-header">Mo</div>
Â  Â  Â  Â  Â  <div class="calendar-day-header">Tu</div>
Â  Â  Â  Â  Â  <div class="calendar-day-header">We</div>
Â  Â  Â  Â  Â  <div class="calendar-day-header">Th</div>
Â  Â  Â  Â  Â  <div class="calendar-day-header">Fr</div>
Â  Â  Â  Â  Â  <div class="calendar-day-header">Sa</div>
Â  Â  Â  Â  Â  <div class="calendar-day-header" style="color: #dc3545;">Su</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="calendar-day" style="grid-column: 6;">1</div>
Â  Â  Â  Â  Â  <div class="calendar-day" style="color: #dc3545;">2</div>
Â  Â  Â  Â  Â  <div class="calendar-day event">3</div>
Â  Â  Â  Â  Â  <div class="calendar-day">4</div>
Â  Â  Â  Â  Â  <div class="calendar-day">5</div>
Â  Â  Â  Â  Â  <div class="calendar-day">6</div>
Â  Â  Â  Â  Â  <div class="calendar-day event">7</div>
Â  Â  Â  Â  Â  <div class="calendar-day">8</div>
Â  Â  Â  Â  Â  <div class="calendar-day" style="color: #dc3545;">9</div>
Â  Â  Â  Â  Â  <div class="calendar-day event">10</div>
Â  Â  Â  Â  Â  <div class="calendar-day">11</div>
Â  Â  Â  Â  Â  <div class="calendar-day">12</div>
Â  Â  Â  Â  Â  <div class="calendar-day">13</div>
Â  Â  Â  Â  Â  <div class="calendar-day">14</div>
Â  Â  Â  Â  Â  <div class="calendar-day">15</div>
Â  Â  Â  Â  Â  <div class="calendar-day" style="color: #dc3545;">16</div>
Â  Â  Â  Â  Â  <div class="calendar-day">17</div>
Â  Â  Â  Â  Â  <div class="calendar-day">18</div>
Â  Â  Â  Â  Â  <div class="calendar-day">19</div>
Â  Â  Â  Â  Â  <div class="calendar-day">20</div>
Â  Â  Â  Â  Â  <div class="calendar-day">21</div>
Â  Â  Â  Â  Â  <div class="calendar-day">22</div>
Â  Â  Â  Â  Â  <div class="calendar-day" style="color: #dc3545;">23</div>
Â  Â  Â  Â  Â  <div class="calendar-day">24</div>
Â  Â  Â  Â  Â  <div class="calendar-day">25</div>
Â  Â  Â  Â  Â  <div class="calendar-day">26</div>
Â  Â  Â  Â  Â  <div class="calendar-day">27</div>
Â  Â  Â  Â  Â  <div class="calendar-day today">28</div>
Â  Â  Â  Â  Â  <div class="calendar-day">29</div>
Â  Â  Â  Â  Â  <div class="calendar-day" style="color: #dc3545;">30</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  </div>

Â  </div> </div>

<div class="modal fade" id="addTaskModal" tabindex="-1">
Â  <div class="modal-dialog">
Â  Â  <div class="modal-content" style="border-radius:12px">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h5 class="modal-title">Add Task</h5>
Â  Â  Â  Â  <button class="btn-close" data-bs-dismiss="modal"></button>
Â  Â  Â  </div>

Â  Â  Â  <form action="{{ url_for('add_task') }}" method="POST">
Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  <label class="form-label small">Task Name</label>
Â  Â  Â  Â  Â  <input type="text" name="task_name" class="form-control mb-3" required>

Â  Â  Â  Â  Â  <label class="form-label small">Reminder Time</label>
Â  Â  Â  Â  Â  <input type="datetime-local" name="reminder_time" class="form-control">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="modal-footer">
Â  Â  Â  Â  Â  <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
Â  Â  Â  Â  Â  <button class="btn btn-primary-custom">Add Task</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </form>
Â  Â  </div>
Â  Â  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Define the Flask route URL for AI processing using Jinja
    const aiProcessUrl = "{{ url_for('ai_process') }}";

// --- USERNAME LOGIC (Ensures the greeting works correctly) ---
function checkAndSetUsername() {
Â  Â  let userName = localStorage.getItem('taskPlannerUserName');
Â  Â Â 
Â  Â  // If no name is found, prompt the user (optional, can be disabled after first run)
Â  Â  if (!userName && (typeof user === 'undefined' || !user.name)) {
Â  Â  Â  Â  let input = prompt("Welcome! Please enter your name:");
Â  Â  Â  Â  if (input && input.trim() !== '') {
Â  Â  Â  Â  Â  Â  userName = input.trim();
Â  Â  Â  Â  Â  Â  localStorage.setItem('taskPlannerUserName', userName);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  userName = 'there'; // Default name
Â  Â  Â  Â  }
Â  Â  } else if (typeof user !== 'undefined' && user.name) {
        userName = user.name; // Use authenticated name if available
    } else {
        userName = userName || 'there'; // Fallback
    }

Â  Â  // Display only the first name for a friendly greeting
Â  Â  const firstName = userName.split(' ')[0];
Â  Â  const displayElement = document.getElementById('userNameDisplay');
    if (displayElement) {
        displayElement.textContent = firstName + " ğŸ‘‹";
    }
}

// --- THEME TOGGLE AND ONLOAD ---
document.addEventListener('DOMContentLoaded', ()=> {
Â  checkAndSetUsername(); // CALL THE NEW FUNCTION ON LOAD

Â  const themeToggle = document.getElementById('themeToggle');
Â  // theme toggle handler
Â  themeToggle.addEventListener('click', ()=>{
Â  Â  document.body.classList.toggle('dark-mode');
Â  Â  themeToggle.textContent = document.body.classList.contains('dark-mode') ? 'Light' : 'Dark';
Â  });
});


// --- AI FUNCTION (Modified to use aiProcessUrl) ---
async function sendToAI() {
Â  Â  const inputElement = document.getElementById("ai_input");
    const askButton = document.querySelector(".input-group button");
Â  Â  const aiOutput = document.getElementById("ai_output");
Â  Â  const text = inputElement.value;

    if (!text) {
        aiOutput.innerText = "Please enter a question or a task reminder.";
        return;
    }

    askButton.disabled = true;
    inputElement.disabled = true;
Â  Â  aiOutput.innerText = "Processing request... Please wait.";

Â  Â  try {
Â  Â  Â  Â  // Use the Jinja-defined variable for the route
Â  Â  Â  Â  const res = await fetch(aiProcessUrl, {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  body: JSON.stringify({ user_input: text })
Â  Â  Â  Â  });

        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }

Â  Â  Â  Â  const data = await res.json();

Â  Â  Â  Â  // If AI returns an error â†’ show it
Â  Â  Â  Â  if (data.type === "error") {
Â  Â  Â  Â  Â  Â  aiOutput.innerText = "âŒ Error:\n" + (data.message || JSON.stringify(data, null, 2));
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // If AI returns a general conversation â†’ show it
Â  Â  Â  Â  if (data.action !== "add") {
Â  Â  Â  Â  Â  Â  Â // For general chat, display the response cleanly
Â  Â  Â  Â  Â  Â  const chatResponse = data.response || "I am sorry, I could not generate a chat response.";
Â  Â  Â  Â  Â  Â  aiOutput.innerText = "ğŸ¤– Assistant:\n" + chatResponse;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // If AI successfully added a task
Â  Â  Â  Â  // Clean up the ISO string for display (remove Z and milliseconds)
Â  Â  Â  Â  const timeDisplay = data.reminder_timeÂ 
Â  Â  Â  Â  Â  Â  ? data.reminder_time.replace('Z', '').substring(0, 16)Â 
Â  Â  Â  Â  Â  Â  : 'None';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  aiOutput.innerText =
Â  Â  Â  Â  Â  Â  "âœ… Task added:\n" +
Â  Â  Â  Â  Â  Â  "Task: " + data.task + "\n" +
Â  Â  Â  Â  Â  Â  "Time (UTC): " + timeDisplay;

Â  Â  Â  Â  // Refresh automatically to show the new task
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  window.location.reload();
Â  Â  Â  Â  }, 800);
Â  Â  Â  Â Â 
Â  Â  } catch (e) {
Â  Â  Â  Â  aiOutput.innerText = "âŒ Network or unexpected error: " + e.message;
Â  Â  } finally {
        askButton.disabled = false;
        inputElement.disabled = false;
        inputElement.value = '';
    }
}
</script>

</body>
</html>
